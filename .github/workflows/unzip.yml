name: Unzip and flatten CMS archive

on:
  workflow_dispatch:
  push:
    paths:
      - hwood-fixed-deploy.zip

permissions:
  contents: write

concurrency:
  group: unzip-main
  cancel-in-progress: true

jobs:
  unzip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with latest main (before changes)
        run: |
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Unzip archive
        run: |
          unzip -q hwood-complete-cms.zip -d __unzipped

      - name: Flatten into repo root
        run: |
          set -e
          # detect top-level directory inside __unzipped
          TOP_DIR="$(find __unzipped -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          echo "Top folder: $TOP_DIR"

          # move everything (including dotfiles) to repo root
          shopt -s dotglob
          mv "$TOP_DIR"/* .

          # cleanup
          rm -rf __unzipped
          rm -f hwood-complete-cms.zip

      - name: Prevent committing secrets (.env.local)
        run: |
          # ignore and untrack .env.local if present
          if [ -f ".env.local" ]; then
            echo ".env.local" >> .gitignore
            git rm -f --cached .env.local || true
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Extract and flatten CMS archive" || echo "Nothing to commit"

          git push origin main
